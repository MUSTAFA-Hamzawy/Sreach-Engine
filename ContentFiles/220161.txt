[> draft, zhong yu, 2015-06-05, this article explains http cookie domain policy, based on rfc_6265 and current browser behaviors., a website can set a cookie in a response; the cookie will be sent back to the same website in subsequent requests., more precisely, if an http client issues a request to a domain, and the response contains a valid cookie, the client should apply the cookie to subsequent requests to the same domain (subject to other constraints). we say the request domain is the origin domain of the cookie. a cookie is always applicable to its origin domain., for example, cookie foo=bar originated from www.cats.com is applied to later requests to the same domain -, note that the port number doesn't matter here; the scheme(http/https) doesn't matter either (unless cookie's secure attribute is set). in the example above, the cookie originated from http://www.cats.com:8080 is applicable to request to https://www.cats.com:443 as well, even though the schemes and ports are different., if the request host is an ip address, e.g. 127.0.0.1, we say, for the purpose of this article, that the origin domain is the ip., a cookie can have the "domain" attribute set to a valid domain name, which we call the cover domain of the cookie. if the "domain" attribute is not set, we say the cover domain is null., if cover domain is null, a cookie is only applicable to its origin domain. for example, a cookie from www.cats.com is not applicable to cats.com, and vice versa, if cover domain is null., if cover domain is set, a cookie is applicable to the cover domain and all its subdomains. for example, the cover domain is cats.com, therefore the cookie is applicable to cats.com, x.cats.com, x.y.cats.com, etc., the cover domain must cover the origin domain, that is, the cover domain must be the same as, or a parent of, the origin domain. in the example above, the origin domain is foo.www.cats.com, therefore the cover domain could only be set to foo.www.cats.com, www.cats.com, or cats.com (but not "com", see next section)., if the origin domain is an ip, the cover domain must be null. a cookie with an ip origin is only applicable to that ip., a cover domain should not contain a leading dot, like in .cats.com; if it does, the client should remove the leading dot., if a cookie's cover domain is set illegally or incorrectly, the client should ignore the cookie entirely., on a related matter, a cookie's identity is defined by the triplet (name, domain, path), of which domain is either the cover domain if it's set, or the origin domain otherwise. this needs to be noted when replacing or deleting a cookie., obviously, we cannot allow a cover domain to be "com", otherwise, a cookie from cats.com could be sent to dogs.com, causing problems. a cover domain must not be a public suffix., a public suffix is a domain under which the general public can register direct subdomains. for example, "com", "org", "uk", "co.uk" are public suffixes. direct subdomains of a public suffix belong to different owners, therefore their cookies should not mingle, and that's why a public suffix cannot be allowed as cover domain., a private company can also offer a domain as a public suffix. for example, when you lease a server from amazon aws, a domain name is assigned to it, e.g. foo.compute.amazonaws.com. you "own" this domain in the sense that its usage is at your discretion. someone else may own a sibling bar.compute.amazonaws.com. to prevent bar from sending cookies to foo, the domain compute.amazonaws.com is listed as a public suffix., the complete list of public suffixes is maintained at https://publicsuffix.org. in addition, we recommend that, as far as cookie handling is concerned, every tld is a public suffix, even if it's not listed. for example, "test", "local", "my-fake-tld", etc. cannot be allowed as cover domains., as far as cookie handling is concerned, parents of a public suffix are public suffixes too, even if they are not listed. for example, amazonaws.com is not listed as a public suffix, yet it cannot be allowed as cover domain either, because it is the parent of public suffix compute.amazonaws.com., these two bullet points cannot be derived from the texts of rfc_6265 and publicsuffix.org; instead, they are concluded from current behaviors of major browsers. other client and server implementers should follow these behaviors too. it's a simplified and conservative approach for dealing with subtleties of public suffix. see next section for a more complicated narrative., summary of rules from above:, according to rfc_6265, if a cookie's cover domain is a public suffix,, the first clause looks odd, but it permits a public suffix domain (if it ever resolves to an http server) to specify itself as the cover domain, while making sure the cookie will not propagate to subdomains. presumably, this clause is for backward compatibility of some existing websites on public suffix domains. however, the only major browser that currently implements this clause is firefox; all other major browsers simply reject such cookies. therefore in the previous section, to follow the browser consensus, we reject this case as well - a cover domain cannot be a public suffix, regardless of the origin domain., another problem - rfc_6265 does not properly handle the situation where a public suffix has a parent that is not a public suffix; such situation probably didn't exist when the rfc was written. strictly following the texts of the rfc, a client would allow foo.compute.amazonaws.com to set a cookie's cover domain to amazonaws.com, and the cookie would be applicable to bar.compute.amazonaws.com. this behavior is clearly undesired., fortunately, no major browser behaves that way; however, browsers handle the case differently. safari appears to simply treat amazonaws.com as a public suffix, rejecting all cookies with it as cover domain. in the previous section, we follow this simple approach, rejecting any parent of public suffix as cover domain., on the other hand, firefox and chrome take a more sophisticated approach, allowing amazonaws.com as cover domain in some cases (e.g. when the origin domain is www.amazonaws.com) while making sure those cookies do not propagate below compute.amazonaws.com. this approach is better; however, amazon cannot really rely on it to share cookies, because not all browsers support the approach., these discussions intend to justify the conservative approach we laid out in the previous section., nevertheless, it would be interesting to discuss what is the "ideal" way to handle public suffixes in cookie handling -, the domain amazonaws.com is not really a public suffix, because its direct subdomains are not open to the public; instead, they are all controlled by amazon. it doesn't really hurt if www.amazonaws.com and zzz.amazonaws.com, or even compute.amazonaws.com, share cookies though domain amazonaws.com - as long as these cookies do not propagate downwards across public suffix compute.amazonaws.com, reaching user websites. at the same time, we must not allow a user website under compute.amazonaws.com to set a cover domain to amazonaws.com, interfering with amazon's websites., with that in mind, the next section defines a more sensible model for cookie domain policy., a cover domain's coverage is the set of domains that the cookie is applicable to; the set is defined by:, that is, the coverage starts from the domain, propagates downwards, stopped at public suffix nodes., the coverage is tested when receiving and sending the cookie, in a symmetric way, return to the amazon example,, here's a pseudo code for getting the list of cover domains that cover a given request_domain, rfc 6265 - http state management mechanism, browser behaviors on cookie domain and public suffix, a cookie storage using the coverage model, contact: bayou-io@googlegroups.com][cookie domain, origin domain, cover domain, public suffix, more on public suffix, coverage model, links]cookie domain[origin domain, a cookie is always applicable to its origin domain., cover domain, if cover domain is null, a cookie is only applicable to its origin domain., if cover domain is set, a cookie is applicable to the cover domain and all its subdomains., the cover domain must cover the origin domain, a cover domain must not be a public suffix, public suffix, summary of rules, x, x, x][as far as cookie handling is concerned, every tld is a public suffix, even if it's not listed. for example, "test", "local", "my-fake-tld", etc. cannot be allowed as cover domains., as far as cookie handling is concerned, parents of a public suffix are public suffixes too, even if they are not listed. for example, amazonaws.com is not listed as a public suffix, yet it cannot be allowed as cover domain either, because it is the parent of public suffix compute.amazonaws.com., if a cookie's origin domain is an ip, the cover domain must be null., if a cookie's cover domain is null, the cookie is only applicable to its origin domain., if a cookie's cover domain is set, the cookie is applicable to the cover domain and all its subdomains; the cover domain must cover the origin domain; the cover domain must not be a tld, a public suffix, or a parent of a public suffix., the cookie is applicable to the cover domain and all its subdomains;, the cover domain must cover the origin domain;, the cover domain must not be a tld, a public suffix, or a parent of a public suffix., if the origin domain is the same domain, reset the cover domain to null, then accept the cookie, otherwise, ignore the cookie entirely, the set contains the cover domain;, if the set contains x, and x is not a public suffix, the set contains all direct subdomains of x., the cover domain must cover the request domain when the cookie is received when the cookie is applied to a request, when the cookie is received, when the cookie is applied to a request, compute.amazonaws.com only covers itself, since it's a public suffix., amazonaws.com covers amazonaws.com, www.amazonaws.com, foo.www.amazonaws.com, and compute.amazonaws.com; it does not cover foo.compute.amazonaws.com., rfc 6265 - http state management mechanism, browser behaviors on cookie domain and public suffix, a cookie storage using the coverage model]